<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Chat Site</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
body { font-family: sans-serif; margin:0; display:flex; }

#left {
  width: 260px;
  border-right: 1px solid #aaa;
  padding: 10px;
}

#right {
  flex:1;
  display:flex;
  flex-direction:column;
}

#userPanel {
  width: 200px;
  border-left:1px solid #aaa;
  padding:10px;
  background:#f6f6f6;
}

.adminOnly { display:none; }

.room { cursor:pointer; padding:5px; border-bottom:1px solid #ddd; }
.room:hover { background:#eee; }

#chatMessages { flex:1; overflow-y:auto; border-bottom:1px solid #aaa; padding:10px; }
#chatInput { display:flex; }
</style>
</head>
<body>

<!-- ì™¼ìª½ íŒ¨ë„: ë°© ëª©ë¡ / ìƒì„± -->
<div id="left">
  <h3>ë‹‰ë„¤ì„ ì„¤ì •</h3>
  <input id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥"><br><br>
  <button id="saveNick">ë‹‰ë„¤ì„ ì €ì¥</button>
  <br><br>

  <h3>ë°© ê²€ìƒ‰</h3>
  <input id="search" placeholder="ë°© ì´ë¦„ ê²€ìƒ‰">

  <h3>ë°© ëª©ë¡</h3>
  <div id="rooms"></div>

  <h3>ë°© ë§Œë“¤ê¸°</h3>
  <input id="roomName" placeholder="ë°© ì´ë¦„">
  <label><input type="checkbox" id="roomPwCheck"> ë¹„ë°€ë²ˆí˜¸</label>
  <input id="roomPw" placeholder="ë¹„ë°€ë²ˆí˜¸" style="display:none;">
  <button id="createRoom">ë°© ë§Œë“¤ê¸°</button>
</div>


<!-- ì¤‘ì•™: ì±„íŒ… -->
<div id="right">
  <div id="chatMessages"></div>

  <div id="chatInput">
    <input id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥" style="flex:1;">
    <button id="send">ì „ì†¡</button>
  </div>
</div>


<!-- ì˜¤ë¥¸ìª½: ê´€ë¦¬ì ì „ìš© ì‚¬ìš©ì ëª©ë¡ -->
<div id="userPanel" class="adminOnly">
  <h3>ì ‘ì†ì</h3>
  <div id="userList"></div>
</div>


<script>
const socket = io();
let currentRoom = null;
let isAdmin = false;

// -------------------- UI ì»¨íŠ¸ë¡¤ --------------------
document.getElementById("roomPwCheck").addEventListener("change", e=>{
  document.getElementById("roomPw").style.display = e.target.checked ? "block" : "none";
});

document.getElementById("saveNick").onclick = () => {
  const nick = document.getElementById("nickname").value.trim();
  if (!nick) return alert("ë‹‰ë„¤ì„ ì…ë ¥!");

  // ê´€ë¦¬ì ë‹‰ë„¤ì„ì¼ ë•Œ ë¹„ë²ˆ ìš”êµ¬
  if (nick === "í¬ë¡œë°”ì¸ ì…ë‹ˆë‹¤") {
    const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
    if (pw !== "ì—¬ê¸°ì—_ê´€ë¦¬ìë¹„ë²ˆ") {
      alert("ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼. ì¼ë°˜ ìœ ì €ë¡œ ì ‘ì†í•©ë‹ˆë‹¤.");
      isAdmin = false;
    } else {
      isAdmin = true;
      document.querySelectorAll(".adminOnly").forEach(el => el.style.display="block");
    }
  }

  socket.emit("setNickname", { nickname: nick, isAdmin });
  alert("ë‹‰ë„¤ì„ ì €ì¥ë¨!");
};


// -------------------- ë°© ëª©ë¡ í‘œì‹œ --------------------
socket.on("roomList", list => {
  const box = document.getElementById("rooms");
  box.innerHTML = "";

  list.forEach(r => {
    const div = document.createElement("div");
    div.className="room";
    div.innerHTML = `${r.name} ${r.hasPassword?"ğŸ”’":""}`;
    div.onclick = () => joinRoom(r.id, r.hasPassword);
    box.appendChild(div);
  });
});


// -------------------- ë°© ì…ì¥ --------------------
function joinRoom(id, needPw) {
  let pw = "";
  if (needPw && !isAdmin) pw = prompt("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");

  socket.emit("joinRoom", { roomId: id, password: pw });
}

socket.on("joinSuccess", roomId => {
  currentRoom = roomId;
  document.getElementById("chatMessages").innerHTML = "";
});

socket.on("joinFailed", msg => alert(msg));


// -------------------- ì±„íŒ… --------------------
document.getElementById("send").onclick = () => {
  const msg = document.getElementById("message").value;
  if (!msg || !currentRoom) return;

  socket.emit("sendMessage", { roomId: currentRoom, message: msg });
  document.getElementById("message").value = "";
};

socket.on("newMessage", m => {
  const box = document.getElementById("chatMessages");
  const div = document.createElement("div");
  div.innerHTML = `<b>${m.nickname}:</b> ${m.message}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
});

socket.on("chatHistory", list => {
  const box = document.getElementById("chatMessages");
  box.innerHTML = "";
  list.forEach(m => {
    const div = document.createElement("div");
    div.innerHTML = `<b>${m.nickname}:</b> ${m.message}`;
    box.appendChild(div);
  });
});


// -------------------- ì‚¬ìš©ì ëª©ë¡ (ê´€ë¦¬ìë§Œ) --------------------
socket.on("userList", users => {
  if (!isAdmin) return;

  const box = document.getElementById("userList");
  box.innerHTML="";

  users.forEach(u => {
    const wrap = document.createElement("div");
    wrap.innerHTML = `
      ${u.nickname}
      <button onclick="warnUser('${u.nickname}')">âš </button>
      <button onclick="banUser('${u.nickname}')">ğŸ”¨</button>
    `;
    box.appendChild(wrap);
  });
});

window.warnUser = (nick) => {
  socket.emit("warnUser", { targetNick: nick });
};

window.banUser = (nick) => {
  if (!confirm(nick + " ë‹˜ì„ ì§„ì§œ ë°´í•©ë‹ˆê¹Œ?")) return;
  socket.emit("banUser", { targetNick: nick });
};


// -------------------- ê²½ê³ /ë°´ ì•Œë¦¼ --------------------
socket.on("warn", msg => alert(msg));
socket.on("banned", msg => {
  alert(msg);
  location.reload();
});
</script>
</body>
</html>
