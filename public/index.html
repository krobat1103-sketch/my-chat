<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì±„íŒ… ì‚¬ì´íŠ¸</title>
  <style>
    body { font-family: Arial; background:#f3f3f3; margin:0; padding:20px; }
    #login, #chatUI { max-width:600px; margin:auto; }
    #roomList div { padding:8px; background:#fff; margin:4px 0; border-radius:5px; cursor:pointer; }
    #messages { height:300px; overflow-y:auto; background:white; padding:10px; border-radius:5px; }
    .msg { margin:5px 0; }
    .sys { color:#888; }
    #userList { margin-top:10px; background:white; padding:10px; border-radius:5px; }
    #adminTools { margin-top:20px; background:#fff3d1; padding:10px; border-radius:5px; }
    video { max-width:100%; margin-top:6px; }
    img { max-width:100%; margin-top:6px; }
  </style>
</head>
<body>

<!-- ë¡œê·¸ì¸ í™”ë©´ -->
<div id="login">
  <h2>ë‹‰ë„¤ì„ ì„¤ì •</h2>
  <input id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" />
  <br><br>

  <!-- ê´€ë¦¬ì ì „ìš© (ë³´í˜¸ëœ ë‹‰ë„¤ì„ ì„ íƒ ì‹œë§Œ ë“±ì¥) -->
  <div id="adminPasswordArea" style="display:none;">
    <input id="adminPassword" type="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />
    <br><br>
  </div>

  <button id="enterBtn">ì…ì¥</button>

  <hr>

  <h3>ì±„íŒ…ë°© ëª©ë¡</h3>
  <input id="searchRoom" placeholder="ë°© ê²€ìƒ‰" />
  <button id="searchBtn">ê²€ìƒ‰</button>
  <div id="roomList"></div>

  <h3>ë°© ë§Œë“¤ê¸°</h3>
  <input id="newRoomName" placeholder="ë°© ì´ë¦„" />
  <br>
  <label><input type="checkbox" id="roomHasPw"> ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</label><br>
  <input id="newRoomPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="display:none;">
  <br>
  <button id="createRoomBtn">ë°© ìƒì„±</button>
</div>

<!-- ì±„íŒ… UI -->
<div id="chatUI" style="display:none;">
  <h2 id="roomTitle"></h2>

  <div id="messages"></div>

  <h3>ì‚¬ìš©ì ëª©ë¡</h3>
  <div id="userList"></div>

  <br>
  <input id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥" style="width:70%;">
  <button id="sendBtn">ì „ì†¡</button>
  <br><br>

  <input type="file" id="fileUpload">
  <button id="uploadBtn">ì—…ë¡œë“œ</button>

  <br><br>
  <button id="leaveBtn">ë°© ë‚˜ê°€ê¸°</button>
  <button id="deleteRoomBtn">ë°© ì‚­ì œ (ë°©ì¥ë§Œ)</button>

  <!-- ê´€ë¦¬ì íŒ¨ë„ -->
  <div id="adminTools" style="display:none;">
    <h3>ê´€ë¦¬ì ë„êµ¬</h3>
    <input id="banNickname" placeholder="ë°´í•  ë‹‰ë„¤ì„">
    <button id="banBtn">ë°´</button>

    <br><br>

    <input id="unbanNickname" placeholder="ì–¸ë°´ ë‹‰ë„¤ì„">
    <button id="unbanBtn">ì–¸ë°´</button>

    <h4>ë°´ ëª©ë¡</h4>
    <div id="banList"></div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();
let nickname = "";
let currentRoomId = null;

const ADMIN_NICK = "í¬ë¡œë°”ì¸ ì…ë‹ˆë‹¤";

const login = document.getElementById("login");
const chatUI = document.getElementById("chatUI");
const adminPasswordArea = document.getElementById("adminPasswordArea");
const adminPasswordInput = document.getElementById("adminPassword");

document.getElementById("nickname").addEventListener("input", () => {
  if (document.getElementById("nickname").value === ADMIN_NICK)
    adminPasswordArea.style.display = "block";
  else
    adminPasswordArea.style.display = "none";
});

document.getElementById("searchBtn").onclick = () => {
  socket.emit("searchRooms", document.getElementById("searchRoom").value);
};

document.getElementById("enterBtn").onclick = () => {
  alert("ë°©ì„ í´ë¦­í•˜ì—¬ ì…ì¥í•˜ì„¸ìš”!");
};

socket.on("roomList", list => {
  const rl = document.getElementById("roomList");
  rl.innerHTML = "";
  list.forEach(r => {
    const div = document.createElement("div");
    div.innerHTML = `${r.name} ${r.hasPassword ? "(ğŸ”’)" : ""}`;
    div.onclick = () => joinRoomDialog(r.id, r.hasPassword);
    rl.appendChild(div);
  });
});

function joinRoomDialog(roomId, hasPw) {
  nickname = document.getElementById("nickname").value;
  if (!nickname) return alert("ë‹‰ë„¤ì„ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”");

  let pw = "";
  let adminPass = "";

  if (nickname === ADMIN_NICK)
    adminPass = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");

  if (hasPw)
    pw = prompt("ë°© ë¹„ë°€ë²ˆí˜¸:");

  socket.emit("joinRoom", { roomId, nickname, password: pw, adminPass });
}

document.getElementById("roomHasPw").onclick = () => {
  document.getElementById("newRoomPw").style.display =
    document.getElementById("roomHasPw").checked ? "block" : "none";
};

document.getElementById("createRoomBtn").onclick = () => {
  nickname = document.getElementById("nickname").value;
  if (!nickname) return alert("ë‹‰ë„¤ì„ í•„ìš”");

  const name = document.getElementById("newRoomName").value;
  const hasPw = document.getElementById("roomHasPw").checked;
  const pw = document.getElementById("newRoomPw").value;

  let adminPass = "";

  if (nickname === ADMIN_NICK)
    adminPass = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");

  socket.emit("createRoom", {
    roomName: name,
    hasPassword: hasPw,
    password: hasPw ? pw : "",
    nickname,
    adminPass
  });
};

socket.on("createFailed", msg => alert(msg));
socket.on("joinFailed", msg => alert(msg));

socket.on("joinSuccess", (roomId) => {
  currentRoomId = roomId;

  login.style.display = "none";
  chatUI.style.display = "block";

  document.getElementById("roomTitle").innerHTML = "ë°© ID: " + roomId;
});

socket.on("chatHistory", list => {
  const m = document.getElementById("messages");
  m.innerHTML = "";
  list.forEach(addMsg);
});

socket.on("newMessage", addMsg);

function addMsg(msg) {
  const div = document.createElement("div");
  div.className = "msg";

  if (msg.type === "text") {
    div.innerHTML = `<b>${msg.nickname}</b>: ${msg.message}`;
  } else if (msg.type === "image") {
    div.innerHTML = `<b>${msg.nickname}</b>: <br><img src="${msg.message}">`;
  } else if (msg.type === "video") {
    div.innerHTML = `<b>${msg.nickname}</b>: <br><video controls src="${msg.message}"></video>`;
  }

  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop = 999999;
}

socket.on("systemMessage", m => {
  const div = document.createElement("div");
  div.className = "msg sys";
  div.innerHTML = m;
  document.getElementById("messages").appendChild(div);
});

socket.on("roomUsers", list => {
  const ul = document.getElementById("userList");
  ul.innerHTML = "";
  list.forEach(n => {
    const d = document.createElement("div");
    d.innerHTML = n;
    ul.appendChild(d);
  });
});

document.getElementById("sendBtn").onclick = () => {
  const txt = document.getElementById("chatInput").value;
  if (!txt) return;
  socket.emit("sendMessage", {
    roomId: currentRoomId,
    nickname,
    message: txt,
    type: "text"
  });
  document.getElementById("chatInput").value = "";
};

document.getElementById("uploadBtn").onclick = async () => {
  const file = document.getElementById("fileUpload").files[0];
  if (!file) return alert("íŒŒì¼ ì„ íƒí•˜ì„¸ìš”");

  const form = new FormData();
  form.append("file", file);

  const res = await fetch("/upload", { method: "POST", body: form });
  const data = await res.json();

  const type = data.mime.startsWith("image")
    ? "image"
    : data.mime.startsWith("video")
    ? "video"
    : "file";

  socket.emit("sendMessage", {
    roomId: currentRoomId,
    nickname,
    message: data.url,
    type
  });
};

document.getElementById("leaveBtn").onclick = () => {
  socket.emit("leaveRoom", { roomId: currentRoomId, nickname });

  chatUI.style.display = "none";
  login.style.display = "block";
};

document.getElementById("deleteRoomBtn").onclick = () => {
  socket.emit("deleteRoom", { roomId: currentRoomId, nickname });
};

socket.on("banned", msg => {
  alert(msg);
  location.reload();
});

socket.on("banList", list => {
  document.getElementById("banList").innerHTML = list.join("<br>");
});

// ê´€ë¦¬ì ë„êµ¬ í‘œì‹œì¡°ê±´
setInterval(() => {
  if (nickname === ADMIN_NICK)
    document.getElementById("adminTools").style.display = "block";
  else
    document.getElementById("adminTools").style.display = "none";
}, 1000);

document.getElementById("banBtn").onclick = () => {
  const target = document.getElementById("banNickname").value;
  const pass = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
  socket.emit("banUser", { targetNick: target, adminNick: nickname, adminPass: pass });
};

document.getElementById("unbanBtn").onclick = () => {
  const target = document.getElementById("unbanNickname").value;
  const pass = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
  socket.emit("unbanUser", { targetNick: target, adminNick: nickname, adminPass: pass });
};
</script>
</body>
</html>
