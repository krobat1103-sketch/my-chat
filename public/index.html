새로운 메시지를 확인하려면 새로고침해주세여
<div>개발&운영:크로바츠</div>



<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Chat Site (Full)</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 12px; }
  #messages img { max-width: 200px; display:block; margin:5px 0; }
  #messages video { max-width: 320px; display:block; margin:5px 0; }
  #roomUsers { margin-top:8px; }
  .userItem { display:flex; gap:6px; align-items:center; }
  .adminBtn { background:#e33; color:white; border:none; padding:2px 6px; border-radius:4px; cursor:pointer; }
  .ownerBtn { background:#36a; color:white; border:none; padding:2px 6px; border-radius:4px; cursor:pointer; }
</style>
</head>
<body>
<h1>Chat</h1>
<div>
  <label>닉네임: <input id="nickname" placeholder="닉네임"></label>
  <button id="saveNick">저장</button>
  <button id="changeNick">변경</button>
  <span id="adminBadge" style="margin-left:12px;color:green;font-weight:bold;display:none;">관리자</span>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const s=localStorage.getItem('nickname');
  if(s) document.getElementById('nickname').value=s;
  const adminName = "크로바츠입니다";
  if(s === adminName) document.getElementById('adminBadge').style.display = 'inline';
});
document.getElementById('saveNick').addEventListener('click',()=>{
  localStorage.setItem('nickname',document.getElementById('nickname').value);
  const s = document.getElementById('nickname').value;
  if(s === "크로바츠") document.getElementById('adminBadge').style.display = 'inline';
  alert('닉네임 저장됨');
});
document.getElementById('changeNick').addEventListener('click',()=>{
  const n = prompt('새 닉네임 입력', document.getElementById('nickname').value || '');
  if(n!==null){
    document.getElementById('nickname').value = n;
    localStorage.setItem('nickname', n);
    if(n === "크로바츠") document.getElementById('adminBadge').style.display = 'inline';
    else document.getElementById('adminBadge').style.display = 'none';
    alert('닉네임 변경됨');
  }
});
</script>

<h2>방 목록</h2>
<input id="search"><button id="btnSearch">검색</button>
<ul id="roomList"></ul>

<h3>방 만들기</h3>
<input id="newRoomName" placeholder="방 이름">
<label><input type="checkbox" id="usePassword">비밀번호</label>
<input id="roomPassword" placeholder="비밀번호">
<button id="createRoom">생성</button>

<hr>
<div id="chat" style="display:none;">
  <h3 id="roomTitle"></h3>
  <div style="display:flex;gap:12px;">
    <div style="flex:1;">
      <div id="messages" style="height:300px;overflow:auto;border:1px solid #aaa;padding:6px;"></div>
      <input id="msgInput" placeholder="메시지를 입력">
      <button id="sendBtn">전송</button>
      <br><br>
      <input type="file" id="fileInput"><button id="uploadBtn">업로드</button>
      <br><small>새로고침해도 자동으로 재입장됩니다 (비밀번호 있는 방은 재입장 시 비밀번호 입력해야 할 수 있음)</small>
      <br><button id="leaveBtn">방 나가기</button>
    </div>
    <div style="width:260px;">
      <h4>접속자</h4>
      <div id="roomUsers"></div>
      <h4>방 정보</h4>
      <div id="roomInfo"></div>
      <h4>밴 목록 (관리자용)</h4>
      <div id="banList"></div>
    </div>
  </div>
</div>

<script>
const socket = io();
let currentRoomId = null;
const ADMIN_NAME = "크로바츠";

function renderRooms(rooms){
  const list = document.getElementById('roomList');
  list.innerHTML = '';
  rooms.forEach(r=>{
    const li = document.createElement('li');
    li.innerHTML = `<strong>${r.name}</strong> ${r.hasPassword ? '(비번)' : ''} by ${r.owner} 
      <button onclick="promptJoin('${r.id}')">입장</button>
      ${localStorage.getItem('nickname') === r.owner ? `<button class="ownerBtn" onclick="deleteRoom('${r.id}')">삭제</button>` : ''}`;
    list.appendChild(li);
  });
}

socket.on('roomList', renderRooms);

document.getElementById('btnSearch').addEventListener('click',()=>{
  socket.emit('searchRooms', document.getElementById('search').value);
});
document.getElementById('createRoom').addEventListener('click',()=>{
  const nick = localStorage.getItem('nickname') || document.getElementById('nickname').value;
  socket.emit('createRoom', {
    roomName: document.getElementById('newRoomName').value,
    hasPassword: document.getElementById('usePassword').checked,
    password: document.getElementById('roomPassword').value,
    nickname: nick
  });
});

function promptJoin(roomId){
  const nickname = localStorage.getItem('nickname') || document.getElementById('nickname').value;
  const pw = prompt('비밀번호(필요시 입력):');
  joinRoom(roomId, nickname, pw);
}

function joinRoom(roomId, nickname, password){
  if(!nickname) return alert('닉네임 먼저 설정하세요');
  socket.emit('joinRoom', { roomId, nickname, password });
}

// handle join results
socket.on('joinFailed', (msg) => {
  alert(msg);
  const saved = localStorage.getItem('currentRoom');
  if(saved) localStorage.removeItem('currentRoom');
});

socket.on('joinSuccess', (roomId) => {
  currentRoomId = roomId;
  document.getElementById('chat').style.display = 'block';
  document.getElementById('roomTitle').textContent = '방: ' + roomId;
  localStorage.setItem('currentRoom', roomId);
  socket.emit('requestRoomUsers', roomId);
  document.getElementById('roomInfo').textContent = '';
});

// receive history after join
socket.on('chatHistory', (history) => {
  const box = document.getElementById('messages');
  box.innerHTML = '';
  history.forEach(item => appendMessage(item));
  box.scrollTop = box.scrollHeight;
});

socket.on('systemMessage', (txt) => {
  appendSystem(txt);
});

socket.on('roomUsers', (users) => {
  const container = document.getElementById('roomUsers');
  container.innerHTML = '';
  users.forEach(u=>{
    const div = document.createElement('div');
    div.className = 'userItem';
    div.textContent = u;
    // show admin ban button if i'm admin and u is not admin
    const myNick = localStorage.getItem('nickname');
    if(myNick === ADMIN_NAME && u !== ADMIN_NAME){
      const b = document.createElement('button');
      b.className = 'adminBtn';
      b.textContent = '밴';
      b.onclick = ()=> {
        if(confirm(`${u}님을 밴하시겠습니까?`)){
          socket.emit('banUser', { targetNick: u, adminNick: myNick });
        }
      };
      div.appendChild(b);
    }
    container.appendChild(div);
  });
});

socket.on('banList', (list) => {
  const c = document.getElementById('banList');
  c.innerHTML = list.map(x=>`<div>${x}</div>`).join('');
});

socket.on('newMessage', (item) => {
  appendMessage(item);
});

function appendSystem(txt){
  const box = document.getElementById('messages');
  const d = document.createElement('div');
  d.style.fontStyle='italic';
  d.textContent = txt;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}

function appendMessage(item){
  const box = document.getElementById('messages');
  const div = document.createElement('div');
  const t = new Date(item.time).toLocaleTimeString();
  if(item.type === 'text'){
    div.textContent = `${t} ${item.nickname}: ${item.message}`;
  } else if(item.type === 'file'){
    const m = item.message;
    if(m.mime && m.mime.startsWith('image')){
      div.innerHTML = `${t} ${item.nickname}: <br><img src="${m.url}" style="max-width:200px;"> <a href="${m.url}" download>다운</a>`;
    } else if(m.mime && m.mime.startsWith('video')){
      div.innerHTML = `${t} ${item.nickname}: <br><video src="${m.url}" controls style="max-width:320px;"></video> <a href="${m.url}" download>다운</a>`;
    } else if(typeof m === 'string'){
      div.innerHTML = `${t} ${item.nickname}: <a href="${m}" download>파일 다운로드</a>`;
    } else {
      div.textContent = `${t} ${item.nickname}: [파일]`;
    }
  } else {
    div.textContent = `${t} ${item.nickname}: ${JSON.stringify(item.message)}`;
  }
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

document.getElementById('sendBtn').addEventListener('click',()=>{
  sendText();
});
function sendText(){
  const nick = localStorage.getItem('nickname') || document.getElementById('nickname').value;
  const txt = document.getElementById('msgInput').value;
  if(!currentRoomId) return alert('먼저 방에 들어가세요');
  socket.emit('sendMessage', { roomId: currentRoomId, nickname: nick, message: txt, type: 'text' });
  document.getElementById('msgInput').value = '';
}

document.getElementById('uploadBtn').addEventListener('click',()=>{
  const f = document.getElementById('fileInput').files[0];
  if(!f) return alert('파일 선택');
  const fd = new FormData();
  fd.append('file', f);
  fetch('/upload', { method: 'POST', body: fd })
    .then(r => r.json())
    .then(data => {
      const nick = localStorage.getItem('nickname') || document.getElementById('nickname').value;
      socket.emit('sendMessage', { roomId: currentRoomId, nickname: nick, message: data, type: 'file' });
    })
    .catch(err=> alert('업로드 실패'));
});

document.getElementById('leaveBtn').addEventListener('click',()=>{
  const nick = localStorage.getItem('nickname') || document.getElementById('nickname').value;
  socket.emit('leaveRoom', { roomId: currentRoomId, nickname: nick });
  localStorage.removeItem('currentRoom');
  currentRoomId = null;
  document.getElementById('chat').style.display = 'none';
});

function deleteRoom(roomId){
  const nick = localStorage.getItem('nickname');
  if(!nick) return alert('닉네임 필요');
  if(confirm('정말 이 방을 삭제하시겠습니까?')){
    socket.emit('deleteRoom', { roomId, nickname: nick });
  }
}

window.addEventListener('load', ()=>{
  const savedRoom = localStorage.getItem('currentRoom');
  const savedNick = localStorage.getItem('nickname');
  if(savedRoom && savedNick){
    joinRoom(savedRoom, savedNick, null);
  }
});

socket.on('banned', (msg) => {
  alert(msg || '밴되었습니다.');
  localStorage.removeItem('currentRoom');
  localStorage.removeItem('nickname');
  window.location.reload();
});

function promptUnban(target){
  const myNick = localStorage.getItem('nickname');
  if(myNick !== ADMIN_NAME) return alert('관리자만 사용 가능');
  socket.emit('unbanUser', { targetNick: target, adminNick: myNick });
}
</script>
</body>
</html>
