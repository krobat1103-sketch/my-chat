
개발&운영:크로바츠(YT)
상대방이 보낸 메시지를 확인하려면 새로고침해주새요


<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Chat Site (Auto Rejoin)</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  #messages img { max-width: 200px; display:block; margin:5px 0; }
  #messages video { max-width: 320px; display:block; margin:5px 0; }
</style>
</head>
<body>
<h1>Chat</h1>

<div>
  <label>닉네임: <input id="nickname" placeholder="닉네임"></label>
  <button id="saveNick">저장</button>
  <button id="changeNick">변경</button>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const s=localStorage.getItem('nickname');
  if(s) document.getElementById('nickname').value=s;
});
document.getElementById('saveNick').addEventListener('click',()=>{
  localStorage.setItem('nickname',document.getElementById('nickname').value);
  alert('닉네임 저장됨');
});
document.getElementById('changeNick').addEventListener('click',()=>{
  const n = prompt('새 닉네임 입력', document.getElementById('nickname').value || '');
  if(n!==null){
    document.getElementById('nickname').value = n;
    localStorage.setItem('nickname', n);
    alert('닉네임 변경됨');
  }
});
</script>

<h2>방 목록</h2>
<input id="search"><button id="btnSearch">검색</button>
<ul id="roomList"></ul>

<h3>방 만들기</h3>
<input id="newRoomName" placeholder="방 이름">
<label><input type="checkbox" id="usePassword">비밀번호</label>
<input id="roomPassword" placeholder="비밀번호">
<button id="createRoom">생성</button>

<hr>
<div id="chat" style="display:none;">
  <h3 id="roomTitle"></h3>
  <div id="messages" style="height:300px;overflow:auto;border:1px solid #aaa;padding:6px;"></div>
  <input id="msgInput" placeholder="메시지를 입력">
  <button id="sendBtn">전송</button>
  <br><br>
  <input type="file" id="fileInput"><button id="uploadBtn">업로드</button>
  <br><small>새로고침해도 자동으로 재입장됩니다 (비밀번호 있는 방은 재입장 시 비밀번호 입력해야 할 수 있음)</small>
  <br><button id="leaveBtn">방 나가기</button>
</div>

<script>
const socket = io();
let currentRoomId = null;

function renderRooms(rooms){
  const list = document.getElementById('roomList');
  list.innerHTML = '';
  rooms.forEach(r=>{
    const li = document.createElement('li');
    li.innerHTML = `${r.name} ${r.hasPassword ? '(비번)' : ''} <button onclick="promptJoin('${r.id}')">입장</button>`;
    list.appendChild(li);
  });
}

socket.on('roomList', renderRooms);

document.getElementById('btnSearch').addEventListener('click',()=>{
  socket.emit('searchRooms', document.getElementById('search').value);
});
document.getElementById('createRoom').addEventListener('click',()=>{
  socket.emit('createRoom', {
    roomName: document.getElementById('newRoomName').value,
    hasPassword: document.getElementById('usePassword').checked,
    password: document.getElementById('roomPassword').value
  });
});

function promptJoin(roomId){
  const nickname = localStorage.getItem('nickname') || document.getElementById('nickname').value;
  const pw = prompt('비밀번호(필요시 입력):');
  joinRoom(roomId, nickname, pw);
}

function joinRoom(roomId, nickname, password){
  if(!nickname) return alert('닉네임 먼저 설정하세요');
  socket.emit('joinRoom', { roomId, nickname, password });
}

// handle join results
socket.on('joinFailed', (msg) => {
  alert(msg);
  // clear saved room if join failed due to password change etc
  const saved = localStorage.getItem('currentRoom');
  if(saved) localStorage.removeItem('currentRoom');
});

socket.on('joinSuccess', (roomId) => {
  currentRoomId = roomId;
  document.getElementById('chat').style.display = 'block';
  document.getElementById('roomTitle').textContent = '방: ' + roomId;
  localStorage.setItem('currentRoom', roomId);
});

// receive history after join
socket.on('chatHistory', (history) => {
  const box = document.getElementById('messages');
  box.innerHTML = '';
  history.forEach(item => appendMessage(item));
  box.scrollTop = box.scrollHeight;
});

socket.on('systemMessage', (txt) => {
  appendSystem(txt);
});

socket.on('newMessage', (item) => {
  appendMessage(item);
});

function appendSystem(txt){
  const box = document.getElementById('messages');
  const d = document.createElement('div');
  d.style.fontStyle='italic';
  d.textContent = txt;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}

function appendMessage(item){
  const box = document.getElementById('messages');
  const div = document.createElement('div');
  const t = new Date(item.time).toLocaleTimeString();
  if(item.type === 'text'){
    div.textContent = `${t} ${item.nickname}: ${item.message}`;
  } else if(item.type === 'file'){
    const m = item.message;
    if(m.mime && m.mime.startsWith('image')){
      div.innerHTML = `${t} ${item.nickname}: <br><img src="${m.url}" style="max-width:200px;"> <a href="${m.url}" download>다운</a>`;
    } else if(m.mime && m.mime.startsWith('video')){
      div.innerHTML = `${t} ${item.nickname}: <br><video src="${m.url}" controls style="max-width:320px;"></video> <a href="${m.url}" download>다운</a>`;
    } else if(typeof m === 'string'){
      // legacy: if message is a string URL
      div.innerHTML = `${t} ${item.nickname}: <a href="${m}" download>파일 다운로드</a>`;
    } else {
      div.textContent = `${t} ${item.nickname}: [파일]`;
    }
  } else {
    div.textContent = `${t} ${item.nickname}: ${JSON.stringify(item.message)}`;
  }
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

document.getElementById('sendBtn').addEventListener('click',()=>{
  sendText();
});
function sendText(){
  const nick = localStorage.getItem('nickname') || document.getElementById('nickname').value;
  const txt = document.getElementById('msgInput').value;
  if(!currentRoomId) return alert('먼저 방에 들어가세요');
  socket.emit('sendMessage', { roomId: currentRoomId, nickname: nick, message: txt, type: 'text' });
  document.getElementById('msgInput').value = '';
}

document.getElementById('uploadBtn').addEventListener('click',()=>{
  const f = document.getElementById('fileInput').files[0];
  if(!f) return alert('파일 선택');
  const fd = new FormData();
  fd.append('file', f);
  fetch('/upload', { method: 'POST', body: fd })
    .then(r => r.json())
    .then(data => {
      const nick = localStorage.getItem('nickname') || document.getElementById('nickname').value;
      socket.emit('sendMessage', { roomId: currentRoomId, nickname: nick, message: data, type: 'file' });
    })
    .catch(err=> alert('업로드 실패'));
});

document.getElementById('leaveBtn').addEventListener('click',()=>{
  const nick = localStorage.getItem('nickname') || document.getElementById('nickname').value;
  socket.emit('leaveRoom', { roomId: currentRoomId, nickname: nick });
  localStorage.removeItem('currentRoom');
  currentRoomId = null;
  document.getElementById('chat').style.display = 'none';
});

// auto rejoin on load if possible
window.addEventListener('load', ()=>{
  const savedRoom = localStorage.getItem('currentRoom');
  const savedNick = localStorage.getItem('nickname');
  if(savedRoom && savedNick){
    // try to join; if room requires password, user will be prompted
    // attempt without password first
    joinRoom(savedRoom, savedNick, null);
    // if join fails due to password, server will emit joinFailed and we alert and clear saved room
  }
});
</script>
</body>
</html>
