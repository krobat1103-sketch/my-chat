<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Chat Site (Developer Version)</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: Arial; }
  #messages img { max-width: 200px; }
  #messages video { max-width: 320px; }
  #adminPanel { 
    position: fixed; 
    right: 10px; 
    top: 10px; 
    width: 200px; 
    padding: 10px; 
    border: 1px solid #444; 
    background: #f5f5f5; 
    display: none; 
  }
  #adminPanel h3 { margin-top: 0; }
  .banBtn { color: red; cursor: pointer; margin-left: 5px; }
</style>
</head>

<body>

<h2>닉네임:</h2>
<input id="nickname" placeholder="닉네임 입력">
<button id="saveNick">저장</button>
<button id="changeNick">변경</button>

<!-- 관리자 로그인 -->
<button id="adminLoginBtn" style="margin-left:20px;">관리자 로그인</button>

<hr>

<h2>방 목록</h2>
<input id="search"><button id="btnSearch">검색</button>
<ul id="roomList"></ul>

<h3>방 만들기</h3>
<input id="newRoomName" placeholder="방 이름">
<label><input type="checkbox" id="usePassword"> 비밀번호</label>
<input id="roomPassword" placeholder="비밀번호">
<button id="createRoom">생성</button>

<hr>

<!-- 채팅 UI -->
<div id="chat" style="display:none;">
  <h3 id="roomTitle"></h3>
  
  <div id="messages" 
       style="height:300px; overflow:auto; border:1px solid #000; padding:5px;">
  </div>

  <br>
  <input id="msgInput" placeholder="메시지 입력">
  <button id="sendBtn">전송</button>

  <br><br>
  <input type="file" id="fileInput">
  <button id="uploadBtn">업로드</button>

  <br><br>
  <button id="leaveBtn">방 나가기</button>
</div>

<!-- 관리자 패널 -->
<div id="adminPanel">
  <h3>관리자 패널</h3>

  <b>접속자 목록</b><br>
  <ul id="userList"></ul>

  <hr>

  <b>밴 목록(IP)</b>
  <ul id="banList"></ul>
</div>

<script>
const socket = io();
let currentRoomId = null;

document.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem("nickname");
  if (saved) document.getElementById("nickname").value = saved;
});

/* 닉네임 저장 */
document.getElementById("saveNick").addEventListener("click", () => {
  const nick = document.getElementById("nickname").value;
  if (!nick) return alert("닉네임 입력하세요.");
  localStorage.setItem("nickname", nick);
  alert("닉네임 저장됨");
});

/* 닉네임 변경 */
document.getElementById("changeNick").addEventListener("click", () => {
  const now = document.getElementById("nickname").value || "";
  const n = prompt("새 닉네임", now);
  if (n !== null) {
    document.getElementById("nickname").value = n;
    localStorage.setItem("nickname", n);
  }
});

/* ======================
   관리자 로그인
====================== */
document.getElementById("adminLoginBtn").addEventListener("click", () => {
  const nickname = document.getElementById("nickname").value;
  const pw = prompt("관리자 비밀번호 입력");

  socket.emit("adminLogin", { nickname, password: pw });
});

socket.on("adminSuccess", () => {
  alert("관리자 로그인 성공!");
  document.getElementById("adminPanel").style.display = "block";

  // 접속자 목록 요청
  socket.emit("requestUserList");
});

socket.on("adminFailed", () => {
  alert("관리자 로그인 실패 (비밀번호 틀림)");
});

/* 전체 접속자 목록 */
socket.on("allUsers", list => {
  const ul = document.getElementById("userList");
  ul.innerHTML = "";

  list.forEach(nick => {
    const li = document.createElement("li");
    li.textContent = nick;

    // 밴 버튼
    const ban = document.createElement("span");
    ban.textContent = " [밴]";
    ban.className = "banBtn";

    ban.addEventListener("click", () => {
      if (confirm(`${nick} 을(를) 밴하시겠습니까?`)) {
        socket.emit("banIP", { targetNick: nick });
      }
    });

    li.appendChild(ban);
    ul.appendChild(li);
  });
});

/* 밴 목록 표시 */
socket.on("banList", list => {
  const ul = document.getElementById("banList");
  ul.innerHTML = "";
  list.forEach(ip => {
    const li = document.createElement("li");
    li.textContent = ip;
    ul.appendChild(li);
  });
});

/* 밴 되었을 때 */
socket.on("banned", msg => {
  alert(msg);
  location.reload();
});

/* ==============================
   방 목록
================================ */
socket.on("roomList", rooms => {
  const list = document.getElementById("roomList");
  list.innerHTML = "";
  rooms.forEach(r => {
    const li = document.createElement("li");
    li.innerHTML = `${r.name} by ${r.owner} ${r.hasPassword ? "(비번)" : ""} 
                    <button onclick="joinPrompt('${r.id}')">입장</button>`;
    list.appendChild(li);
  });
});

document.getElementById("btnSearch").addEventListener("click", () => {
  socket.emit("searchRooms", document.getElementById("search").value);
});

/* 방 생성 */
document.getElementById("createRoom").addEventListener("click", () => {
  const nickname = localStorage.getItem("nickname");
  const name = document.getElementById("newRoomName").value;
  const usePw = document.getElementById("usePassword").checked;
  const pw = document.getElementById("roomPassword").value;

  socket.emit("createRoom", {
    roomName: name,
    hasPassword: usePw,
    password: pw,
    nickname
  });
});

/* 입장 */
function joinPrompt(id) {
  const nickname = localStorage.getItem("nickname");
  const pw = prompt("비밀번호 (없으면 빈칸)");
  socket.emit("joinRoom", { roomId: id, nickname, password: pw });
}

socket.on("joinSuccess", id => {
  currentRoomId = id;
  document.getElementById("chat").style.display = "block";
  document.getElementById("roomTitle").textContent = "방: " + id;
});

/* 채팅 */
socket.on("chatHistory", list => {
  const box = document.getElementById("messages");
  box.innerHTML = "";
  list.forEach(addMessage);
});

/* 메시지 표시 */
function addMessage(item) {
  const box = document.getElementById("messages");
  const div = document.createElement("div");
  const t = new Date(item.time).toLocaleTimeString();

  if (item.type === "text") {
    div.textContent = `${t} ${item.nickname}: ${item.message}`;
  } else if (item.type === "file") {
    if (item.message.mime.startsWith("image")) {
      div.innerHTML = `${t} ${item.nickname}: <br>
        <img src="${item.message.url}">`;
    } else if (item.message.mime.startsWith("video")) {
      div.innerHTML = `${t} ${item.nickname}: <br>
        <video src="${item.message.url}" controls></video>`;
    }
  }

  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

socket.on("newMessage", addMessage);

/* 메시지 전송 */
document.getElementById("sendBtn").addEventListener("click", () => {
  const nick = localStorage.getItem("nickname");
  const msg = document.getElementById("msgInput").value;

  socket.emit("sendMessage", {
    roomId: currentRoomId,
    nickname: nick,
    message: msg,
    type: "text"
  });

  document.getElementById("msgInput").value = "";
});

/* 파일 업로드 */
document.getElementById("uploadBtn").addEventListener("click", () => {
  const f = document.getElementById("fileInput").files[0];
  if (!f) return alert("파일 선택");

  const fd = new FormData();
  fd.append("file", f);

  fetch("/upload", { method: "POST", body: fd })
    .then(r => r.json())
    .then(d => {
      const nick = localStorage.getItem("nickname");
      socket.emit("sendMessage", {
        roomId: currentRoomId,
        nickname: nick,
        message: d,
        type: "file"
      });
    });
});

/* 방 나가기 */
document.getElementById("leaveBtn").addEventListener("click", () => {
  const nick = localStorage.getItem("nickname");
  socket.emit("leaveRoom", { roomId: currentRoomId, nickname: nick });

  document.getElementById("chat").style.display = "none";
  currentRoomId = null;
});
</script>

</body>
</html>
